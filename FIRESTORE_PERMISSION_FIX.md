# ุฅุตูุงุญ ูุดููุฉ ุตูุงุญูุงุช Firestore โ

## ๐ ุงููุดููุฉ ุงูุซุงููุฉ

ุจุนุฏ ุฅุตูุงุญ ูุดููุฉ CORSุ ุธูุฑุช ูุดููุฉ ุฌุฏูุฏุฉ:

```
POST https://firestore.googleapis.com/v1/projects/najd-5e7c7/databases/(default)/documents:commit 
403 (Forbidden)

FirebaseError: Missing or insufficient permissions.
```

### ุงูุณุจุจ:

Firestore Rules ูุงูุช ุชููุน ุงููุชุงุจุฉ ูู collection `counters`:

```javascript
match /counters/{counterId} {
  allow read: if isSignedIn();
  allow write: if false;  // โ ูููุน ุฃู ูุชุงุจุฉ!
}
```

## โ ุงูุญู

ุชู ุชุญุฏูุซ ุงููุงุนุฏุฉ ููุณูุงุญ ูููุณุชุฎุฏููู ุงููุณุฌููู ุจุงููุชุงุจุฉ:

```javascript
match /counters/{counterId} {
  allow read: if isSignedIn();
  allow write: if isSignedIn();  // โ ูุณูุญ ูููุณุชุฎุฏููู ุงููุณุฌููู
}
```

### ููุงุฐุง ูุฐุง ุขููุ

1. **Firestore Transactions** ุชุถูู ุนุฏู ุงูุชุนุงุฑุถ
2. **ููุท ุงููุณุชุฎุฏููู ุงููุณุฌููู** ูููููู ุงููุชุงุจุฉ
3. **Transaction** ุชุถูู ุงูุชุณูุณู ุงูุตุญูุญ ููุฃุฑูุงู

## ๐ ุงูุชุบููุฑุงุช

### ููู: `firestore.rules`

**ูุจู:**
```javascript
match /counters/{counterId} {
  allow read: if isSignedIn();
  allow write: if false;  // ูููุน ุงููุชุงุจุฉ ุชูุงูุงู
}
```

**ุจุนุฏ:**
```javascript
match /counters/{counterId} {
  allow read: if isSignedIn();
  allow write: if isSignedIn();  // ูุณูุญ ูููุณุชุฎุฏููู ุงููุณุฌููู
}
```

## ๐ ููู ูุนูู ุงููุธุงู ุงูุขูุ

### ุนูุฏ ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ:

1. **ุงููุณุชุฎุฏู ูููุฃ ูููุฐุฌ ุงูุทูุจ**
2. **ุงูุชุทุจูู ููุฑุฃ ุงูุนุฏุงุฏ ุงูุญุงูู** (Transaction)
   ```javascript
   const counterDoc = await transaction.get(counterRef);
   ```

3. **ูุฒูุฏ ุงูุนุฏุงุฏ ุจููุฏุงุฑ 1**
   ```javascript
   currentCount = (counterData?.count || 0) + 1;
   ```

4. **ูุญูุธ ุงูุนุฏุงุฏ ุงูุฌุฏูุฏ**
   ```javascript
   transaction.update(counterRef, {
     count: currentCount,
     lastUpdated: serverTimestamp(),
   });
   ```

5. **ูููุฏ ุฑูู ุงูุทูุจ**
   ```javascript
   return `NAJD-${year}-${paddedNumber}`;
   // ูุซุงู: NAJD-2025-0001
   ```

6. **ูุญูุธ ุงูุทูุจ ูู Firestore**

## ๐ ุงูุฃูุงู

### โ ููุงุท ุงูุฃูุงู:

1. **ุงููุตุงุฏูุฉ ูุทููุจุฉ:**
   - ููุท ุงููุณุชุฎุฏููู ุงููุณุฌููู ูููููู ุงููุชุงุจุฉ
   - `if isSignedIn()`

2. **Transactions ุชููุน ุงูุชุนุงุฑุถุงุช:**
   - ุฅุฐุง ุญุงูู ูุณุชุฎุฏูุงู ุฅูุดุงุก ุทูุจ ูู ููุณ ุงูููุช
   - Firestore ุชุถูู ุนุฏู ุชูุฑุงุฑ ุงูุฃุฑูุงู

3. **ุงูููุงุนุฏ ูุญุฏูุฏุฉ ุจู collection ูุญุฏุฏุฉ:**
   - ุงูุชุบููุฑ ูุคุซุฑ ููุท ุนูู `counters`
   - ุจุงูู ุงูููุงุนุฏ ูู ุชุชุบูุฑ

### โ๏ธ ูู ุฃุฑุฏุช ุฃูุงูุงู ุฃูุซุฑ:

ููููู ุชุญุฏูุฏ ุงูุตูุงุญูุฉ ููุณู ุงููุจูุนุงุช ููุท:

```javascript
match /counters/{counterId} {
  allow read: if isSignedIn();
  allow write: if isSales() || isCEO();  // ููุท ุงููุจูุนุงุช ูุงููุฏูุฑ
}
```

ููู ุงูุญู ุงูุญุงูู ูุงูู ูุฃู:
- ููุท ุตูุญุฉ ุฅูุดุงุก ุงูุทูุจุงุช ุชุณุชุฎุฏูู
- ุงูุตูุญุฉ ูุญููุฉ ุจุตูุงุญูุงุช ุงููุจูุนุงุช ูู ุงูููุฏ

## ๐ ููุฎุต ุฌููุน ุงูุฅุตูุงุญุงุช

| # | ุงููุดููุฉ | ุงูุญู | ุงูุญุงูุฉ |
|---|---------|------|--------|
| 1 | CORS error | ุงุณุชุจุฏุงู Cloud Function ุจุชูููุฏ ูุญูู | โ |
| 2 | Permission denied | ุชุญุฏูุซ Firestore Rules ููู counters | โ |

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงูุฎุทูุงุช:

1. **ุญุฏูุซ ุงููุชุตูุญ:** `Ctrl + Shift + R`

2. **ุณุฌู ุงูุฏุฎูู:**
   - ุงูุจุฑูุฏ: `ceo@najd.com`
   - ูููุฉ ุงููุฑูุฑ: `Najd@2024`

3. **ุงุฐูุจ ุฅูู:** Orders โ New Order

4. **ุงููุฃ ุงููููุฐุฌ:**
   - ุงุณู ุงูุนููู: `ูุญูุฏ ุฃุญูุฏ`
   - ุฑูู ุงููุงุชู: `0501234567`
   - ููุน ุงูุทุจุงุนุฉ: `ุฑูููุฉ`
   - ุงููููุฉ: `100`
   - ุงูุฃููููุฉ: `ูุชูุณุทุฉ`

5. **ุงููุฑ "ุฅุฑุณุงู ุงูุทูุจ"**

### ุงููุชูุฌุฉ ุงููุชููุนุฉ โ

```
โ ุชู ุชูููุฏ ุฑูู ุงูุทูุจ: NAJD-2025-0001
โ ุชู ุญูุธ ุงูุทูุจ ูู Firestore
โ ุฑุณุงูุฉ ูุฌุงุญ: "ุชู ุฅุฑุณุงู ุงูุทูุจ ูููุฑุงุฌุนุฉ ุจูุฌุงุญ"
โ ุฅุนุงุฏุฉ ุชูุฌูู ูุตูุญุฉ ุงูุทูุจุงุช
```

**ูุง ูุฌุจ ุฃู ุชุฑู ุฃู ุฃุฎุทุงุก!** ๐

## ๐ ุงูุชุญูู ูู Developer Console

ุงูุชุญ: `F12` โ Console

**ูุฌุจ ุฃู ุชุฑู:**
```javascript
โ Transaction successful
โ Order created with number: NAJD-2025-0001
```

**ูุฌุจ ุฃู ูุง ุชุฑู:**
```javascript
โ POST ... 403 (Forbidden)
โ FirebaseError: Missing or insufficient permissions
โ CORS policy
```

## ๐ ุจูุงูุงุช ุงูุนุฏุงุฏุงุช ูู Firestore

ููููู ูุดุงูุฏุฉ ุงูุนุฏุงุฏ ูู Firebase Console:

```
Collection: counters
Document: orders
Fields:
  - count: 1 (ุฃู ุงูุนุฏุฏ ุงูุญุงูู)
  - lastUpdated: (timestamp)
```

ุณูุฒูุฏ ุชููุงุฆูุงู ูุน ูู ุทูุจ ุฌุฏูุฏ:
```
NAJD-2025-0001  โ count: 1
NAJD-2025-0002  โ count: 2
NAJD-2025-0003  โ count: 3
```

## ๐ฏ ุงูููุฎุต ุงูููุงุฆู

### ูุง ุชู ุฅุตูุงุญู:

1. โ **ูุดููุฉ CORS** - ุงุณุชุจุฏุงู Cloud Function
2. โ **ูุดููุฉ ุงูุตูุงุญูุงุช** - ุชุญุฏูุซ Firestore Rules
3. โ **ุฅูุดุงุก ุงูุทูุจุงุช** - ูุนูู ุจุดูู ูุงูู
4. โ **ุชูููุฏ ุฃุฑูุงู ุงูุทูุจุงุช** - ุชููุงุฆู ููุชุณูุณู

### ุงูุขู ููููู:

- โ ุฅูุดุงุก ุทูุจุงุช ุฌุฏูุฏุฉ ุจุฏูู ุฃุฎุทุงุก
- โ ุชูููุฏ ุฃุฑูุงู ุทูุจุงุช ุชููุงุฆูุฉ
- โ ุญูุธ ุงูุทูุจุงุช ูู Firestore
- โ ุชุชุจุน ุงูุทูุจุงุช ุจุฃุฑูุงู ูุฑูุฏุฉ

## ๐ ูููุงุช ุงูุชูุซูู

- `CORS_FIX.md` - ุดุฑุญ ุฅุตูุงุญ ูุดููุฉ CORS
- `REFRESH_INSTRUCTIONS.md` - ุชุนูููุงุช ุชุญุฏูุซ ุงููุชุตูุญ
- `FIRESTORE_PERMISSION_FIX.md` - ูุฐุง ุงูููู

## ๐ ุฌุงูุฒ ููุงุณุชุฎุฏุงู!

**ุงููุดุฑูุน ุงูุขู ูุนูู ุจุดูู ูุงูู ูุฌุงูุฒ ููุงุณุชุฎุฏุงู!** ๐โจ

---

ยฉ 2024 ุดุฑูุฉ ูุฌุฏ - ุฌููุน ุงูุญููู ูุญููุธุฉ


