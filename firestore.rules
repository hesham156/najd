rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================
    // Helper Functions
    // ==========================
    
    // التحقق من تسجيل الدخول
    function isSignedIn() {
      return request.auth != null;
    }
    
    // التحقق من أن المستخدم نشط
    function isActiveUser() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isActive == true;
    }
    
    // الحصول على بيانات المستخدم الحالي
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // التحقق من الدور
    function hasRole(role) {
      return isActiveUser() && getUserData().role == role;
    }
    
    // التحقق من القسم
    function hasDepartment(department) {
      return isActiveUser() && getUserData().department == department;
    }
    
    // التحقق من أن المستخدم رئيس قسم
    function isHead() {
      return isActiveUser() && getUserData().isHead == true;
    }
    
    // التحقق من أن المستخدم CEO
    function isCEO() {
      return hasRole('ceo');
    }
    
    // التحقق من أن المستخدم في قسم المبيعات
    function isSales() {
      return hasDepartment('sales');
    }
    
    // التحقق من أن المستخدم مالك المورد
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // ==========================
    // Users Collection
    // ==========================
    match /users/{userId} {
      // القراءة: أي مستخدم نشط يمكنه قراءة بيانات المستخدمين (للشات وإدارة الفريق)
      allow read: if isActiveUser();
      
      // الإنشاء: 
      // - السماح بإنشاء مستخدم إذا كان المستخدم الذي يتم إنشاؤه هو نفس المستخدم المسجل (self-registration)
      // - أو إذا كان المستخدم الحالي CEO
      allow create: if (isSignedIn() && request.auth.uid == userId) || isCEO();
      
      // التحديث: المستخدم يمكنه تحديث بياناته الأساسية، CEO يمكنه تحديث أي شيء
      allow update: if (isOwner(userId) && 
                       // لا يمكن تغيير الدور أو القسم
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'department', 'isHead', 'isActive'])
                      ) || isCEO();
      
      // الحذف: CEO فقط
      allow delete: if isCEO();
    }
    
    // ==========================
    // Orders Collection
    // ==========================
    match /orders/{orderId} {
      // القراءة:
      // - CEO: يمكنه رؤية كل الطلبات
      // - رؤساء الأقسام: يمكنهم رؤية كل الطلبات
      // - الموظفين: يمكنهم رؤية طلبات قسمهم فقط
      allow read: if isActiveUser() && (
        isCEO() || 
        isHead() ||
        // المبيعات يرون طلباتهم
        (isSales() && resource.data.createdBy == request.auth.uid) ||
        // الأقسام الأخرى ترى الطلبات المرتبطة بقسمها
        (hasDepartment('design') && resource.data.status in [
          'pending_design', 'in_design', 'design_review', 'design_completed'
        ]) ||
        (hasDepartment('printing') && resource.data.status in [
          'pending_printing', 'in_printing', 'printing_completed'
        ]) ||
        (hasDepartment('accounting') && (
          resource.data.status in ['pending_payment', 'payment_confirmed'] ||
          // قسم الحسابات يمكنه رؤية طلبات عروض الأسعار في أي حالة
          resource.data.isQuotation == true
        )) ||
        (hasDepartment('dispatch') && (
          resource.data.status in [
            'pending_materials', 'materials_in_progress', 'materials_ready',
            'ready_for_dispatch', 'in_dispatch', 'delivered'
          ]
        ))
      );
      
      // الإنشاء: المبيعات ورؤساء أقسام المبيعات
      allow create: if isActiveUser() && 
                      (isSales() || (hasDepartment('sales') && isHead())) &&
                      request.resource.data.createdBy == request.auth.uid &&
                      request.resource.data.status in ['draft', 'pending_ceo_review'];
      
      // التحديث:
      // صلاحيات محددة حسب الدور والحالة
      allow update: if isActiveUser() && (
        // CEO: يمكنه تحديث أي طلب
        isCEO() ||
        
        // رؤساء الأقسام: يمكنهم تحديث أي طلب
        isHead() ||
        
        // المبيعات: يمكنه تحديث طلباته في حالات معينة
        (isSales() && 
         resource.data.createdBy == request.auth.uid &&
         resource.data.status in ['draft', 'returned_to_sales'] &&
         request.resource.data.diff(resource.data).affectedKeys().hasAny(['customerName', 'customerPhone', 'customerEmail', 'customerAddress', 'printType', 'quantity', 'needsDesign', 'designDescription', 'materials', 'notes', 'estimatedCost', 'priority', 'requestedDeliveryDate', 'files', 'comments', 'updatedAt'])) ||
        
        // التصميم: يمكنه تحديث الطلبات في مراحل التصميم فقط
        (hasDepartment('design') && 
         resource.data.status in ['pending_design', 'in_design', 'design_review', 'design_completed'] &&
         request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'assignedToDesign', 'designDescription', 'timeline', 'comments', 'updatedAt'])) ||
        
        // الطباعة: يمكنه تحديث الطلبات في مراحل الطباعة فقط
        (hasDepartment('printing') && 
         resource.data.status in ['pending_printing', 'in_printing', 'printing_completed'] &&
         request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'assignedToPrinting', 'timeline', 'comments', 'updatedAt'])) ||
        
        // الحسابات: يمكنه تحديث التسعيرة والدفعات
        (hasDepartment('accounting') && 
         (resource.data.status in ['printing_completed', 'pending_payment', 'payment_confirmed'] ||
          request.resource.data.diff(resource.data).affectedKeys().hasAny(['estimatedCost', 'finalCost', 'paidAmount', 'paymentStatus', 'paymentRecords', 'accountingReviewedCost', 'costVariancePercentage', 'timeline', 'comments', 'updatedAt', 'status']))) ||
        
        // الإرسال: يمكنه تحديث حالة المواد والإرسال
        (hasDepartment('dispatch') && 
         resource.data.status in ['pending_materials', 'materials_in_progress', 'materials_ready', 'ready_for_dispatch', 'in_dispatch', 'delivered'] &&
         request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'materialsStatus', 'assignedToDispatch', 'actualDeliveryDate', 'timeline', 'comments', 'updatedAt']))
      );
      
      // الحذف: CEO فقط
      allow delete: if isCEO();
    }
    
    // ==========================
    // Notifications Collection
    // ==========================
    match /notifications/{notificationId} {
      // القراءة: المستخدم يمكنه قراءة إشعاراته فقط
      allow read: if isSignedIn() && resource.data.recipientId == request.auth.uid;
      
      // الإنشاء: المستخدمين النشطين يمكنهم إنشاء إشعارات
      // (للإشعارات المباشرة مثل الموافقات)
      allow create: if isActiveUser() && 
                      request.resource.data.recipientId != null;
      
      // التحديث: المستخدم يمكنه تحديث حالة القراءة لإشعاراته
      allow update: if isSignedIn() && 
                      resource.data.recipientId == request.auth.uid &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead', 'readAt']);
      
      // الحذف: المستخدم يمكنه حذف إشعاراته
      allow delete: if isSignedIn() && resource.data.recipientId == request.auth.uid;
    }
    
    // ==========================
    // Quotations Collection
    // ==========================
    match /quotations/{quotationId} {
      // القراءة:
      // - CEO: يمكنه رؤية جميع عروض الأسعار
      // - قسم الحسابات: يمكنهم رؤية جميع عروض الأسعار
      // - المبيعات: يمكنهم رؤية جميع عروض الأسعار (لطلباتهم)
      // - رؤساء الأقسام: يمكنهم رؤية جميع عروض الأسعار
      allow read: if isActiveUser() && (
        isCEO() ||
        isHead() ||
        hasDepartment('accounting') ||
        hasDepartment('sales')
      );
      
      // الإنشاء: قسم الحسابات فقط
      allow create: if hasDepartment('accounting') &&
                      request.resource.data.preparedBy == request.auth.uid &&
                      request.resource.data.status in ['quotation_draft', 'quotation_pending_approval'];
      
      // التحديث:
      // - CEO: يمكنه الموافقة أو الرفض
      // - قسم الحسابات: يمكنهم تحديث عروض الأسعار التي أعدوها
      allow update: if isActiveUser() && (
        // CEO يمكنه تحديث أي عرض سعر (للموافقة/الرفض)
        isCEO() ||
        // قسم الحسابات يمكنهم تحديث عروض الأسعار
        (hasDepartment('accounting') && (
          resource.data.preparedBy == request.auth.uid ||
          isHead()
        ))
      );
      
      // الحذف: CEO أو من أعده
      allow delete: if isCEO() || 
                      (hasDepartment('accounting') && resource.data.preparedBy == request.auth.uid);
    }
    
    // ==========================
    // Invoices Collection
    // ==========================
    match /invoices/{invoiceId} {
      // القراءة: نفس صلاحيات عروض الأسعار
      allow read: if isActiveUser() && (
        isCEO() ||
        hasDepartment('accounting') ||
        (isSales() && exists(/databases/$(database)/documents/orders/$(resource.data.relatedOrderId)) &&
         get(/databases/$(database)/documents/orders/$(resource.data.relatedOrderId)).data.createdBy == request.auth.uid)
      );
      
      // الإنشاء: قسم الحسابات فقط
      allow create: if hasDepartment('accounting') &&
                      request.resource.data.preparedBy == request.auth.uid;
      
      // التحديث: قسم الحسابات أو CEO
      allow update: if isActiveUser() && (
        isCEO() ||
        (hasDepartment('accounting') && (
          resource.data.preparedBy == request.auth.uid ||
          isHead()
        ))
      );
      
      // الحذف: CEO فقط
      allow delete: if isCEO();
    }
    
    // ==========================
    // Counters Collection
    // ==========================
    match /counters/{counterId} {
      // القراءة: المستخدمين المسجلين فقط
      allow read: if isSignedIn();
      
      // الكتابة: 
      // - عداد الطلبات: المبيعات ورؤساء أقسام المبيعات يمكنهم تحديثه
      // - باقي العدادات: عبر Cloud Functions فقط
      allow write: if isActiveUser() && (
        (counterId == 'orders' && (isSales() || (hasDepartment('sales') && isHead())))
      );
    }
    
    // ==========================
    // Activity Logs Collection
    // ==========================
    match /activity_logs/{logId} {
      // القراءة: CEO ورؤساء الأقسام فقط
      allow read: if isCEO() || isHead();
      
      // الكتابة: عبر Cloud Functions فقط
      allow write: if false;
    }
    
    // ==========================
    // Chats Collection - نظام الشات الهرمي
    // ==========================
    match /chats/{chatId} {
      // صلاحيات مؤقتة مفتوحة للاختبار - سيتم تضييقها لاحقاً
      allow read, write: if isSignedIn();
      
      // ==========================
      // Messages Subcollection
      // ==========================
      match /messages/{messageId} {
        // دالة للتحقق من أن المستخدم مشارك في المحادثة الأب
        function isParticipantInParentChat() {
          return request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        }
        
        // القراءة: المستخدمون المشاركون في المحادثة فقط
        allow read: if isActiveUser() && isParticipantInParentChat();
        
        // الإنشاء: المستخدمون المشاركون يمكنهم إرسال رسائل
        allow create: if isActiveUser() && 
                        isParticipantInParentChat() &&
                        request.resource.data.senderId == request.auth.uid;
        
        // التحديث: المرسل يمكنه تحديث رسالته (تعديل، تحديث حالة القراءة)
        // والمستقبل يمكنه تحديث حالة القراءة
        allow update: if isActiveUser() && (
          (resource.data.senderId == request.auth.uid) ||
          (isParticipantInParentChat() && 
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'readBy', 'updatedAt']))
        );
        
        // الحذف: المرسل يمكنه حذف رسالته
        allow delete: if isActiveUser() && resource.data.senderId == request.auth.uid;
      }
    }
    
    // ==========================
    // Typing Indicators Collection
    // ==========================
    match /typing_indicators/{indicatorId} {
      // القراءة: المستخدمون النشطون فقط (real-time updates)
      allow read: if isActiveUser();
      
      // الكتابة: المستخدم يمكنه تحديث حالة الكتابة الخاصة به
      allow write: if isActiveUser() && 
                     request.resource.data.userId == request.auth.uid;
    }
    
    // ==========================
    // Voice Calls Collection
    // ==========================
    match /calls/{callId} {
      // دالة للتحقق من أن المستخدم مشارك في المكالمة
      function isCallParticipant() {
        return request.auth.uid == resource.data.callerId || 
               request.auth.uid == resource.data.receiverId;
      }
      
      // القراءة: المشاركون في المكالمة فقط
      allow read: if isActiveUser() && isCallParticipant();
      
      // الإنشاء: المستخدم يمكنه بدء مكالمة
      allow create: if isActiveUser() && 
                      request.resource.data.callerId == request.auth.uid;
      
      // التحديث: المشاركون يمكنهم تحديث حالة المكالمة
      allow update: if isActiveUser() && isCallParticipant();
      
      // الحذف: ممنوع
      allow delete: if false;
    }
    
    // ==========================
    // Inventory Collection - المخزون
    // ==========================
    match /inventory/{itemId} {
      // القراءة: جميع المستخدمين النشطين يمكنهم قراءة المخزون
      // (لأن الأقسام تحتاج لرؤية مخزون الأقسام الأخرى للتنسيق)
      allow read: if isActiveUser();
      
      // الإنشاء: موظفو القسم يمكنهم إضافة مواد
      allow create: if isActiveUser() && 
                      request.resource.data.createdBy == request.auth.uid &&
                      hasDepartment(request.resource.data.department);
      
      // التحديث: 
      // - موظفو القسم أو CEO يمكنهم تحديث أي شيء
      // - المبيعات يمكنهم تقليل الكمية فقط (لإنشاء الطلبات)
      allow update: if isActiveUser() && (
        isCEO() ||
        hasDepartment(resource.data.department) ||
        (isSales() && 
         request.resource.data.quantity < resource.data.quantity &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['quantity', 'status', 'updatedAt', 'lastModifiedBy', 'lastModifiedAt']))
      );
      
      // الحذف: رئيس القسم أو CEO
      allow delete: if isActiveUser() && (
        isCEO() ||
        (hasDepartment(resource.data.department) && isHead())
      );
    }
    
    // ==========================
    // Material Requests Collection - طلبات الخامات
    // ==========================
    match /material_requests/{requestId} {
      // القراءة: القسم الطالب ورؤساء الأقسام والـ CEO
      allow read: if isActiveUser() && (
        isCEO() ||
        (hasDepartment(resource.data.department)) ||
        (isHead())
      );
      
      // الإنشاء: موظفو الأقسام
      allow create: if isActiveUser() && 
                      request.resource.data.requestedBy == request.auth.uid &&
                      hasDepartment(request.resource.data.department);
      
      // التحديث: رئيس القسم أو CEO (للموافقة/الرفض)
      allow update: if isActiveUser() && (
        isCEO() ||
        (hasDepartment(resource.data.department) && isHead())
      );
      
      // الحذف: من أنشأه أو رئيس القسم
      allow delete: if isActiveUser() && (
        resource.data.requestedBy == request.auth.uid ||
        (hasDepartment(resource.data.department) && isHead()) ||
        isCEO()
      );
    }
    
    // ==========================
    // Inventory Transactions Collection - حركات المخزون
    // ==========================
    match /inventory_transactions/{transactionId} {
      // القراءة: القسم المعني
      allow read: if isActiveUser();
      
      // الإنشاء: موظفو الأقسام (تلقائي عند التحديث)
      allow create: if isActiveUser() &&
                      request.resource.data.performedBy == request.auth.uid;
      
      // التحديث والحذف: ممنوع (سجل دائم)
      allow update, delete: if false;
    }
    
    // ==========================
    // Purchase Requests Collection - طلبات الشراء
    // ==========================
    match /purchase_requests/{requestId} {
      // القراءة: المبيعات (من أنشأه)، رؤساء الأقسام، والـ CEO
      allow read: if isActiveUser() && (
        isCEO() ||
        isHead() ||
        resource.data.requestedBy == request.auth.uid ||
        hasDepartment(resource.data.department)
      );
      
      // الإنشاء: المبيعات فقط (لطلب خامات لطلبات العملاء)
      allow create: if isActiveUser() && 
                      isSales() &&
                      request.resource.data.requestedBy == request.auth.uid &&
                      request.resource.data.department == 'sales';
      
      // التحديث: CEO (للموافقة/الرفض/تحديث الحالة)
      allow update: if isActiveUser() && isCEO();
      
      // الحذف: من أنشأه (قبل الموافقة فقط) أو CEO
      allow delete: if isActiveUser() && (
        (resource.data.requestedBy == request.auth.uid && resource.data.status == 'pending') ||
        isCEO()
      );
    }
    
    // ==========================
    // Customers Collection - العملاء
    // ==========================
    match /customers/{customerId} {
      // القراءة: 
      // - CEO: يمكنه رؤية جميع العملاء
      // - مندوب المبيعات: يمكنه رؤية عملاءه فقط
      // - رؤساء الأقسام: يمكنهم رؤية جميع العملاء
      allow read: if isActiveUser() && (
        isCEO() ||
        isHead() ||
        (isSales() && resource.data.createdBy == request.auth.uid)
      );
      
      // الإنشاء: المبيعات يمكنهم إضافة عملاء جدد
      allow create: if isActiveUser() && 
                      isSales() &&
                      request.resource.data.createdBy == request.auth.uid;
      
      // التحديث: من أضافه أو CEO أو رؤساء الأقسام
      allow update: if isActiveUser() && (
        isCEO() ||
        isHead() ||
        (isSales() && resource.data.createdBy == request.auth.uid)
      );
      
      // الحذف: من أضافه أو CEO
      allow delete: if isActiveUser() && (
        isCEO() ||
        (isSales() && resource.data.createdBy == request.auth.uid)
      );
    }
    
    // ==========================
    // Counters Collection (تحديث)
    // ==========================
    match /counters/purchase_requests {
      allow read: if isSignedIn();
      allow write: if isActiveUser() && isSales();
    }
    
    // رفض الوصول لأي شيء آخر
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

